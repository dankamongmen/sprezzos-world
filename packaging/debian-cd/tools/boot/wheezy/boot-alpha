#!/bin/bash
#
# Do install stuff for alpha, including making bootable CDs
# Works with debian-installer
#
#Vorlon:
#
#The following pieces are still missing:
#
#- MILO bootloader & images.  I have no way to test this directly, and
#  haven't used MILO for years, so I'm giving this a pass on the first
#  run.
#- Floppy images.  Currently, debian-installer claims not to support
#  the floppy target on alpha, which is arbitrary, but there may just not
#  be any reason to continue supporting this install method.  Another
#  decision that can be made later.
#
# $1 is the CD number
# $2 is the temporary CD build dir

. $BASEDIR/tools/boot/$DI_CODENAME/common.sh

set -e

N=$1
CDDIR=$2
BOOTDIR=
if [ "$DI_WWW_HOME" = "default" ];then
   DI_WWW_HOME="http://d-i.debian.org/daily-images/alpha/daily/cdrom/"
   if [ -n "$DI_DIR" ];then
      DI_DIR="$DI_DIR/${DI_WWW_HOME#*http://}"
      DI_WWW_HOME=""                     
   fi
fi
if [ ! "$DI_DIST" ]; then
   DI_DIST="$DI_CODENAME"
fi

cd $CDDIR/..

#
# This script is called with $1 (now $N) as the CD to 
# make bootable.  N may be in the form "n" or "n_NONUS"
# There may be more than 4 disks...support extras.

# Strip NONUS part of disk number
# NN will be 1...N so it can be used as an index
#
NN=`echo $N | sed -e 's/_NONUS//'`

# Common options for all disks
add_mkisofs_opt $CDDIR/../$N.mkisofs_opts "-J -joliet-long"
add_mkisofs_opt $CDDIR/../$N.mkisofs_opts "-cache-inodes"
add_mkisofs_opt $CDDIR/../$N.mkisofs_opts "-l"

# Only disk 1* bootable
if [ $N != 1 -a $N != 1_NONUS ]; then
	exit 0
fi

mkdir boot$N
ab_deb=`ls $MIRROR/pool/main/a/aboot/aboot-base_*.deb | tail -1`
ar p $ab_deb data.tar.gz | tar zxf - -C boot$N/ ./boot/bootlx

# Download boot images
# XXX: Driver floppies?  Any alpha that /has/ a CDROM should be able to
# boot from it, so this would be pure convenience of distribution.
#for image in cd_drivers-image.img cdrom-image.img cdrom-initrd.gz floppy-image.img floppy-initrd.gz net_drivers-image.img netboot-initrd.gz vmlinuz ; do

for image in initrd.gz vmlinuz; do
    if [ ! -e "$image" ]; then
	if [ ! "$DI_WWW_HOME" ];then
		if [ ! "$DI_DIR" ];then
		   DI_DIR="$MIRROR/dists/$DI_DIST/main/installer-$ARCH/current/images/cdrom"
		fi
		cp "$DI_DIR/$image" .
	else
		wget "$DI_WWW_HOME/$image"
	fi
    fi
done

echo "Using $THISTYPE boot-disks image on CD$N"
mkdir -p boot$N/boot
cp initrd.gz vmlinuz boot$N/boot/
mkdir -p boot$N/etc

RSIZE=$(expr $(zcat boot$N/boot/initrd.gz | wc --bytes) / 1024)
OPTS="ramdisk_size=$RSIZE initrd=/boot/initrd.gz root=/dev/ram devfs=mount,dall $KERNEL_PARAMS"

echo "0:boot/vmlinuz $OPTS"               >  boot$N/etc/aboot.conf
echo "1:boot/vmlinuz $OPTS console=ttyS0" >> boot$N/etc/aboot.conf
echo "2:boot/vmlinuz $OPTS console=ttyS1" >> boot$N/etc/aboot.conf

mkdir -p boot$N/milo

add_mkisofs_opt $CDDIR/../$N.mkisofs_opts "-alpha-boot boot/bootlx"

add_mkisofs_opt $CDDIR/../$N.mkisofs_dirs "boot$N"

#install_languages $CDDIR
